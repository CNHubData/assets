name: Batch Upload Profile Pictures from SharePoint

on:
  workflow_dispatch:
    inputs:
      json_url:
        description: 'URL of the JSON file on SharePoint'
        required: true

jobs:
  download-and-process-images:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Install jq for JSON parsing
        run: sudo apt-get install jq

      - name: Download and Process JSON
        run: |
          curl -L "${{ github.event.inputs.json_url }}" -o images.json
          jq -c '.[]' images.json | while read i; do
            img_url=$(echo $i | jq -r '.image_url')
            img_name=$(echo $i | jq -r '.image_name')
            curl -L $img_url -o "./profile_pictures/$img_name"
          done

      - name: Commit and Push Images to Repository
        env:
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add ./profile_pictures
          git commit -m "Batch upload of profile pictures from SharePoint"
          git remote set-url origin https://x-access-token:${ACCESS_TOKEN}@github.com/CNHubData/assets.git
          git push origin main
